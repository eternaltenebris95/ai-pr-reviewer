name: AI Pull Request Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Get diff
      - name: Get code diff
        run: |
      git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
      git diff FETCH_HEAD...HEAD > diff.txt
      echo "=== DIFF GENERATED ==="
      cat diff.txt

      # Step 3: Build Docker image
      - name: Build reviewer Docker image
        run: docker build -t ai-reviewer .

      # Step 4: Run reviewer and save output
      - name: Run AI code review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat diff.txt | docker run -e OPENAI_API_KEY="$OPENAI_API_KEY" -i ai-reviewer > review_output.txt

      # Step 5: Post or update comment
      - name: Post or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ¤– Automated AI Pull Request Review
            Thank you for your PR! Hereâ€™s the AI review:

            ```
            $(cat review_output.txt)
            ```
          edit-mode: replace
